# docker-compose -f docker-compose-local.yml up -d 명령어로 실행
services:
  modaba-postgres:
    image: postgres:17-alpine
    restart: always
    # network_mode: host 제거 (Windows 로컬 연결을 위해 브리지 사용)
    ports:
      - "5432:5432"  # 로컬의 5432 포트와 연결
    environment:
      TZ: Asia/Seoul
      POSTGRES_DB: postgres
      POSTGRES_USER: c204
      POSTGRES_PASSWORD: "ssafy#204"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/01-initSchema.sql
      - ./data.sql:/docker-entrypoint-initdb.d/02-initData.sql

  modaba-redis:
    image: redis:7-alpine
    restart: always
    # network_mode: host 제거
    ports:
      - "6379:6379"  # 로컬의 6379 포트와 연결
    command: redis-server --appendonly yes
    volumes:
      - ./redis_data:/data

  modaba-backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: modaba-backend:latest
    restart: on-failure
    # network_mode: host 제거
    ports:
      - "8080:8080"  # 로컬 웹 접속을 위해 8080 포트 개방
    env_file: .env # 상위 폴더의 .env를 읽으려면 ../.env 로 수정이 필요할 수 있습니다.
    
    environment:
      # 시스템 설정
      TZ: Asia/Seoul
      
      # Database 설정 (Docker 내부 통신을 위해 서비스명 사용)
      SPRING_DATASOURCE_URL: jdbc:postgresql://modaba-postgres:5432/${POSTGRES_DB:-postgres}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-c204}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-ssafy#204}
      
      # Redis 설정 (Docker 내부 통신을 위해 서비스명 사용)
      SPRING_DATA_REDIS_HOST: modaba-redis
      SPRING_DATA_REDIS_PORT: 6379
      
      # OAuth 및 기타 설정은 .env에서 자동으로 로드됨
    depends_on:
      - modaba-postgres
      - modaba-redis