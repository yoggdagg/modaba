<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.s14p11c204.server.domain.game.dao.GameMapper">

    <select id="findParticipantRole" resultType="com.ssafy.s14p11c204.server.domain.game.dto.PlayerRole">
        SELECT role FROM Room_Participants
        WHERE room_id = #{roomId} AND user_id = #{userId}
    </select>

    <select id="findGameRoomDetail" resultType="com.ssafy.s14p11c204.server.domain.game.dto.GameRoomDetailDto">
        SELECT
            room_id as roomId,
            title,
            status,
            host_id as hostId
        FROM Rooms
        WHERE room_id = #{roomId}
    </select>

    <select id="findDetailedParticipants" resultType="com.ssafy.s14p11c204.server.domain.game.dto.GameParticipantDto">
        SELECT
            rp.user_id as userId,
            u.nickname,
            u.profile_image_url as profileImageUrl,
            rp.role,
            rp.status as status,
            CASE WHEN r.host_id = rp.user_id THEN true ELSE false END as isHost,
            CASE WHEN rp.status = 'READY' THEN true ELSE false END as isReady
        FROM Room_Participants rp
        JOIN Users u ON rp.user_id = u.user_id
        JOIN Rooms r ON rp.room_id = r.room_id
        WHERE rp.room_id = #{roomId}
    </select>

    <select id="findGameParticipants" resultType="com.ssafy.s14p11c204.server.domain.game.dto.GameResultDto$PlayerResultDto">
        SELECT
            u.user_id as userId,
            u.nickname,
            rp.role,
            u.mmr as oldMmr
        FROM Room_Participants rp
        JOIN Users u ON rp.user_id = u.user_id
        WHERE rp.room_id = #{roomId}
    </select>

    <update id="updateUserMmr">
        UPDATE Users SET mmr = #{newMmr} WHERE user_id = #{userId}
    </update>

    <insert id="insertMmrHistory">
        INSERT INTO mmr_history (user_id, game_id, change_value, result_mmr, created_at)
        VALUES (#{userId}, #{gameId}, #{changeValue}, #{finalMmr}, NOW())
    </insert>

    <update id="updateGameSession">
        UPDATE game_sessions
        SET end_time = NOW(),
            avg_mmr = #{avgMmr},
            winner_team = #{winnerTeam}
        WHERE room_id = #{roomId} AND end_time IS NULL
    </update>

    <insert id="createGameSession">
        INSERT INTO game_sessions (room_id, start_time)
        VALUES (#{roomId}, NOW())
    </insert>

    <select id="findCurrentSessionId" resultType="long">
        SELECT session_id
        FROM game_sessions
        WHERE room_id = #{roomId}
        ORDER BY start_time DESC
        LIMIT 1
    </select>

    <select id="findRoomIdBySessionId" resultType="long">
        SELECT room_id
        FROM game_sessions
        WHERE session_id = #{sessionId}
    </select>

    <!-- 현재 진행 중인 세션의 시작 시간 조회 -->
    <select id="findCurrentSessionStartTime" resultType="java.time.LocalDateTime">
        SELECT start_time
        FROM game_sessions
        WHERE room_id = #{roomId} AND end_time IS NULL
        ORDER BY start_time DESC
        LIMIT 1
    </select>

    <insert id="insertActionLog">
        INSERT INTO action_logs (session_id, actor_id, target_id, type, created_at)
        VALUES (#{sessionId}, #{actorId}, #{targetId}, #{type}::action_type, NOW())
    </insert>

</mapper>
