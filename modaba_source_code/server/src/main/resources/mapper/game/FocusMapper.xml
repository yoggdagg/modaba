<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.s14p11c204.server.domain.game.dao.FocusMapper">

    <insert id="upsertFocusLog">
        INSERT INTO focus_records (session_id, user_id, focus_scores)
        VALUES (#{sessionId}, #{userId}, jsonb_build_array(#{scoreEntryJson}::jsonb))
        ON CONFLICT (session_id, user_id) -- (주의: 이 제약조건이 DB에 설정되어 있어야 함)
        DO UPDATE SET 
            focus_scores = focus_records.focus_scores || #{scoreEntryJson}::jsonb,
            created_at = NOW();
    </insert>

    <update id="updateAverageScore">
        UPDATE focus_records
        SET avg_score = (
            SELECT AVG((val->>'score')::numeric)
            FROM jsonb_array_elements(focus_scores) AS val
        )
        WHERE session_id = #{sessionId} AND user_id = #{userId};
    </update>

</mapper>
