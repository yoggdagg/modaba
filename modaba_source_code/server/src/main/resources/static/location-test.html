<!DOCTYPE html>
<html>
<head>
    <title>Chat Test (Pure WebSocket)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h2>Chat Test (Pure WebSocket)</h2>

    <div>
        <label>Room ID: </label>
        <input type="text" id="roomId" value="1">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()" disabled id="disconnectBtn">Disconnect</button>
    </div>
    <br>

    <div>
        <label>Sender ID: </label>
        <input type="text" id="senderId" value="1">
        <label>Nickname: </label>
        <input type="text" id="senderNickname" value="Tester">
    </div>
    <br>

    <div>
        <input type="text" id="message" placeholder="Message">
        <button onclick="sendMessage()" disabled id="sendBtn">Send</button>
    </div>

    <h3>Messages</h3>
    <ul id="messages"></ul>

    <script>
        var stompClient = null;

        function connect() {
            var roomId = document.getElementById("roomId").value;

            // 순수 WebSocket 연결
            var socket = new WebSocket('ws://localhost:8081/ws-stomp');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                setConnected(true);

                // 구독 (Subscribe)
                stompClient.subscribe('/sub/chat/room/' + roomId, function (message) {
                    console.log("Message Received: ", message);
                    showMessage(JSON.parse(message.body));
                });
            }, function (error) {
                console.log('STOMP Error: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }

        function sendMessage() {
            var roomId = document.getElementById("roomId").value;
            var senderId = document.getElementById("senderId").value;
            var senderNickname = document.getElementById("senderNickname").value;
            var messageContent = document.getElementById("message").value;

            if (!messageContent) return;

            var chatMessage = {
                'roomId': roomId,
                'senderId': senderId,
                'senderNickname': senderNickname,
                'message': messageContent,
                'type': 'TALK'
            };

            console.log("Sending: ", chatMessage);

            // 발행 (Publish)
            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));

            document.getElementById("message").value = '';
        }

        function showMessage(message) {
            var ul = document.getElementById("messages");
            var li = document.createElement("li");
            li.appendChild(document.createTextNode(message.senderNickname + ": " + message.message));
            ul.appendChild(li);
        }

        function setConnected(connected) {
            document.getElementById("disconnectBtn").disabled = !connected;
            document.getElementById("sendBtn").disabled = !connected;
            document.getElementById("messages").innerHTML = "";
        }
    </script>
</body>
</html>