<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“» ê²½ë„ ë¬´ì „ê¸° ìµœì¢… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #263238; color: white; display: flex; justify-content: center; padding: 50px; }
        .card { background: #37474f; width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin: 5px; transition: 0.2s; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-red { background: #f44336; color: white; }
        .ptt-btn { 
            width: 180px; height: 180px; border-radius: 50%; background: #cfd8dc; color: #37474f; 
            font-size: 24px; font-weight: bold; border: 10px solid #546e7a; cursor: pointer; margin: 30px 0;
        }
        .ptt-btn:active { background: #ff5252; color: white; transform: scale(0.95); }
        .ptt-btn:disabled { background: #455a64; color: #78909c; cursor: not-allowed; }
        .log { height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; font-family: monospace; font-size: 11px; text-align: left; border-radius: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Kyungdo Radio Test</h2>
    
    <div style="margin-bottom: 20px;">
        <input type="text" id="email" value="test@example.com" style="padding: 10px; border-radius: 5px; border: none; width: 40%;">
        <input type="password" id="password" value="password123!" style="padding: 10px; border-radius: 5px; border: none; width: 30%;">
        <button id="login-btn" class="btn btn-blue">ë¡œê·¸ì¸</button>
    </div>

    <button id="connect-btn" class="btn btn-blue" disabled>ì›¹ì†Œì¼“ ì—°ê²°</button>
    <div id="conn-status" style="font-size: 12px; margin-top: 5px; color: #90a4ae;">ìƒíƒœ: ë¯¸ì—°ê²°</div>

    <div style="margin-top: 15px;">
        <label><input type="checkbox" id="loopback-chk"> ë£¨í”„ë°± ëª¨ë“œ (ì„œë²„ ì—ì½” í…ŒìŠ¤íŠ¸)</label>
    </div>

    <button id="ptt-btn" class="ptt-btn" disabled>PTT</button>
    
    <p style="font-size: 14px; color: #b0bec5;">ë²„íŠ¼ì„ ëˆ„ë¥¸ ì±„ë¡œ ë§í•˜ê³  ë–¼ì„¸ìš”!</p>

    <div class="log" id="log">ì¤€ë¹„ ì™„ë£Œ.</div>
</div>

<script>
    let token = null;
    let stomp = null;
    let recorder = null;
    let chunks = [];

    const logger = document.getElementById('log');
    function log(m) {
        const d = document.createElement('div');
        d.textContent = `> ${m}`;
        logger.appendChild(d);
        logger.scrollTop = logger.scrollHeight;
    }

    // 1. ë¡œê·¸ì¸ (í† í° ìë™ ì„¸íŒ…)
    document.getElementById('login-btn').onclick = async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            const r = await fetch('/api/v0/auth/log-in', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            if (!r.ok) {
                const err = await r.json();
                log('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + (err.message || r.statusText));
                return;
            }

            const d = await r.json();
            token = d.accessToken;
            log('ë¡œê·¸ì¸ ì„±ê³µ! ë‹‰ë„¤ì„: ' + d.nickname);
            document.getElementById('connect-btn').disabled = false;
        } catch (e) { 
            log('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + e.message); 
        }
    };

    // 2. ì›¹ì†Œì¼“ ì—°ê²° & êµ¬ë… (ë¬´ì „ ì „ìš© ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
    document.getElementById('connect-btn').onclick = () => {
        // ì¼ë°˜ ì±„íŒ…ì€ /ws-stomp, ë¬´ì „ì€ /ws-radioë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws-radio';
        stomp = Stomp.client(url);
        stomp.connect({ 'Authorization': 'Bearer ' + token }, () => {
            log('ë¬´ì „ ì„œë²„ ì—°ê²° ì„±ê³µ! (/ws-radio)');
            document.getElementById('conn-status').textContent = 'ìƒíƒœ: ì—°ê²°ë¨ (POLICE ì±„ë„)';
            document.getElementById('conn-status').style.color = '#4CAF50';
            document.getElementById('ptt-btn').disabled = false;
            
            // JWT ë””ì½”ë”©í•˜ì—¬ userId ì¶”ì¶œ (ë£¨í”„ë°± êµ¬ë…ìš©)
            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.userId;
            log('ë‚´ ìœ ì € ID: ' + userId);

            // 1. íŒ€ ì±„ë„ êµ¬ë… (Room ID: 1, Team: POLICE ê³ ì •)
            stomp.subscribe(`/sub/voice/team/1/POLICE`, (msg) => {
                const data = JSON.parse(msg.body);
                log(`ğŸ“¡ ìˆ˜ì‹ (íŒ€): ${data.audioData.length} bytes`);
                play(data.audioData);
            });

            // 2. ë£¨í”„ë°± ì „ ì „ìš© ì±„ë„ êµ¬ë…
            stomp.subscribe(`/sub/voice/loopback/${userId}`, (msg) => {
                const data = JSON.parse(msg.body);
                log(`ğŸ”„ ë£¨í”„ë°± ìˆ˜ì‹ : ${data.audioData.length} bytes`);
                play(data.audioData);
            });
        });
    };

    // 3. ë…¹ìŒ (PTT)
    const btn = document.getElementById('ptt-btn');
    btn.onmousedown = async () => {
        chunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // --- ë‹¤ì´ì–´íŠ¸ ì„¤ì •: 16kbps (ë¬´ì „ê¸° ìŒì§ˆ) ---
        const options = { audioBitsPerSecond: 16000 };
        recorder = new MediaRecorder(stream, options);
        
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                const isLoopback = document.getElementById('loopback-chk').checked;
                
                stomp.send("/pub/radio/voice", {}, JSON.stringify({ 
                    roomId: 1, 
                    audioData: base64,
                    timestamp: Date.now() / 1000,
                    loopback: isLoopback
                }));
                log('ğŸ™ï¸ ì „ì†¡ ì™„ë£Œ! (ë£¨í”„ë°±: ' + isLoopback + ')');
            };
            reader.readAsDataURL(blob);
        };
        recorder.start();
        log('ğŸ”´ ë…¹ìŒ ì¤‘...');
    };
    btn.onmouseup = () => { if(recorder) recorder.stop(); };

    // 4. ì¬ìƒ (Blob URL ë°©ì‹)
    function play(base64) {
        const binary = atob(base64);
        const array = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
        
        const blob = new Blob([array], { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play().catch(e => log('ì¬ìƒ ì—ëŸ¬: ' + e.message));
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    }
</script>

</body>
</html>
